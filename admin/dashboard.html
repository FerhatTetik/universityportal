<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli - Kampüs Portalı</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #343a40;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,.8);
            padding: 1rem;
        }
        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255,255,255,.1);
        }
        .sidebar .nav-link.active {
            background: #0d6efd;
            color: white;
        }
        .main-content {
            padding: 2rem;
        }
        .stat-card {
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 sidebar">
                <div class="p-3">
                    <h4>Admin Paneli</h4>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">
                            <i class="fas fa-home me-2"></i> Ana Sayfa
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/duyurular">
                            <i class="fas fa-bullhorn me-2"></i> Duyurular
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/haberler">
                            <i class="fas fa-newspaper me-2"></i> Haberler
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="galeri.html">
                            <i class="fas fa-images me-2"></i> Galeri
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/kullanicilar">
                            <i class="fas fa-users me-2"></i> Kullanıcılar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt me-2"></i> Çıkış Yap
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Ana İçerik -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Kontrol Paneli</h2>
                    <div class="user-info">
                        <span class="me-2">Hoş geldiniz, Admin</span>
                        <img src="https://via.placeholder.com/40" class="rounded-circle" alt="Profil">
                    </div>
                </div>

                <!-- İstatistik Kartları -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-bullhorn text-primary"></i>
                            <h3 id="activeAnnouncementsCount">0</h3>
                            <p class="text-muted mb-0">Aktif Duyuru</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-newspaper text-success"></i>
                            <h3 id="totalNewsCount">0</h3>
                            <p class="text-muted mb-0">Toplam Haber</p>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-users text-warning"></i>
                            <h3>12</h3>
                            <p class="text-muted mb-0">Aktif Kullanıcı</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-eye text-danger"></i>
                            <h3 id="visitorCount">0</h3>
                            <p class="text-muted mb-0">Toplam Ziyaretçi</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <i class="fas fa-circle text-success"></i>
                            <h3 id="onlineUsersCount">0</h3>
                            <p class="text-muted mb-0">Online Kullanıcı</p>
                        </div>
                    </div>
                </div>

                <!-- Son Aktiviteler -->
                <div class="row mt-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Son Aktiviteler</h5>
                            </div>
                            <div class="card-body">
                                <div class="list-group" id="recentActivities">
                                    <!-- Son aktiviteler JavaScript ile buraya eklenecek -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Hızlı İşlemler</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="/admin/haber-ekle" class="btn btn-success">
                                        <i class="fas fa-plus me-2"></i>Haber Ekle
                                    </a>
                                    </a>
                                    <a href="/admin/duyuru-ekle" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Duyuru Ekle
                                    </a>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API endpoint'leri
        const API_URL = 'http://localhost:3000/api';
        let csrfToken = '';

        // CSRF token'ı al
        async function getCsrfToken() {
            try {
                const response = await fetch(`${API_URL}/csrf-token`, {
                    credentials: 'include'
                });
                const data = await response.json();
                csrfToken = data.csrfToken;
            } catch (error) {
                console.error('CSRF token alınamadı:', error);
            }
        }

        // Fetch wrapper fonksiyonu
        async function fetchWithCsrf(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });
            if (response.status === 403) {
                // CSRF token geçersiz, yeni token al
                await getCsrfToken();
                // İsteği tekrarla
                return fetch(url, { ...defaultOptions, ...options });
            }
            return response;
        }

        // İstatistikleri güncelle
        async function updateStats() {
            try {
                // Aktif duyuruları getir
                const announcementsResponse = await fetchWithCsrf(`${API_URL}/announcements`);
                const announcements = await announcementsResponse.json();
                const activeAnnouncements = announcements.filter(a => a.status === 1).length;
                document.getElementById('activeAnnouncementsCount').textContent = activeAnnouncements;

                // Toplam haberleri getir
                const newsResponse = await fetchWithCsrf(`${API_URL}/news`);
                const news = await newsResponse.json();
                document.getElementById('totalNewsCount').textContent = news.length;

                // Son aktiviteleri getir
                const activities = [];
                
                // Son duyurular
                const recentAnnouncements = announcements
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 3);
                
                recentAnnouncements.forEach(announcement => {
                    activities.push({
                        type: 'duyuru',
                        title: announcement.title,
                        date: new Date(announcement.created_at),
                        content: announcement.content
                    });
                });

                // Son haberler
                const recentNews = news
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                    .slice(0, 3);
                
                recentNews.forEach(news => {
                    activities.push({
                        type: 'haber',
                        title: news.title,
                        date: new Date(news.created_at),
                        content: news.content
                    });
                });

                // Aktiviteleri tarihe göre sırala
                activities.sort((a, b) => b.date - a.date);

                // Son aktiviteleri göster
                const activitiesContainer = document.getElementById('recentActivities');
                activitiesContainer.innerHTML = activities.slice(0, 5).map(activity => `
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Yeni ${activity.type === 'duyuru' ? 'Duyuru' : 'Haber'} Eklendi</h6>
                            <small>${formatDate(activity.date)}</small>
                        </div>
                        <p class="mb-1">${activity.title}</p>
                    </a>
                `).join('');

            } catch (error) {
                console.error('İstatistikler güncellenirken hata:', error);
            }
        }

        // Tarih formatla
        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 60) {
                return `${minutes} dakika önce`;
            } else if (hours < 24) {
                return `${hours} saat önce`;
            } else {
                return `${days} gün önce`;
            }
        }

        // WebSocket bağlantısı
        const ws = new WebSocket('ws://localhost:3001');
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'onlineUsers') {
                document.getElementById('onlineUsersCount').textContent = data.count;
            }
        };

        ws.onclose = function() {
            console.log('WebSocket bağlantısı kesildi');
        };

        // Token kontrolü
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Kullanıcı rolünü kontrol et
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || (user.role !== 'admin' && user.role !== 'editor')) {
                window.location.href = '../index.html';
                return;
            }
            
            return token;
        }

        // JWT token kontrolü
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/admin/giris';
        }

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', async () => {
            // CSRF token'ı al
            await getCsrfToken();

            const token = checkAuth();
            if (!token) return;
            
            // Kullanıcı rolüne göre menü öğelerini göster/gizle
            const user = JSON.parse(localStorage.getItem('user'));
            const kullanicilarLink = document.querySelector('a[href="kullanicilar.html"]').parentElement;
            const newUserBtn = document.getElementById('newUserBtn');
            
            if (user.role === 'admin') {
                kullanicilarLink.style.display = 'block';
                newUserBtn.style.display = 'block';
            } else {
                kullanicilarLink.style.display = 'none';
                newUserBtn.style.display = 'none';
            }

            // İstatistikleri güncelle
            updateStats();

            // Her 30 saniyede bir istatistikleri güncelle
            setInterval(updateStats, 30000);

            // Ziyaretçi sayısını getir
            fetch('http://localhost:3000/api/visitors')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('visitorCount').textContent = data.count;
                })
                .catch(error => console.error('Ziyaretçi sayısı alınamadı:', error));
        });

        // Çıkış yapma işlevi
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            if(confirm('Çıkış yapmak istediğinizden emin misiniz?')) {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html> 